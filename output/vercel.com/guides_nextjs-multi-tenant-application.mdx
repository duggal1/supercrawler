---
title: How to Build a Multi-Tenant App with Custom Domains Using Next.js
description: No description
keywords: No keywords
author: Lee Robinson
---

## Table of Contents

{/* Auto-generated table of contents */}

[← Back toGuides](/guides)

# How to Build a Multi-Tenant App with Custom Domains Using Next.js

In this guide, you'll learn how to build a full-stack multi-tenant application by using the[Platforms Starter Kit](https://demo.vercel.pub/platforms-starter-kit)and the following technologies:

* [Next.js](https://nextjs.org/)App Router as the React framework
* [Tailwind](https://tailwindcss.com/)for CSS styling
* [Tremor](https://tremor.so/)for beautiful charts
* [Prisma](https://prisma.io/)as the ORM for database access
* [Novel](https://novel.sh/)for the WYSIWYG editor
* [Postgres](https://vercel.com/storage/postgres)as the database
* [Vercel Blob](https://vercel.com/storage/blob)for image uploads
* [NextAuth.js](https://next-auth.js.org/)for authentication
* [Vercel](http://vercel.com/)for deployment, custom domains & free SSL certificates

You can find the code for this app on the[Platforms Starter Kit Github page](https://github.com/vercel/platforms).

In this guide, we look at 2 ways to deploy this application:

* [Deploy from the template](#option-1:-deploying-from-the-template)
* [Deploy from the Github repository](#option-2:-deploying-from-the-github-repository)

## Features

At the end of this tutorial, you'll get a powerful full-stack application with the following features:

1. Multi-tenancy – programmatically assign unlimited custom domains, subdomains, and SSL certificates to your users
1. Ultra-performant blog posts cached via[Vercel's Edge Network](https://vercel.com/docs/concepts/edge-network/overview), with the ability to invalidate the cache on-demand (when users make changes) using[Incremental Static Regeneration](https://vercel.com/docs/concepts/next.js/incremental-static-regeneration).
1. AI powered Markdown editor for a Notion- writing experience
1. Drag & drop / copy & paste image uploads
1. Custom fonts, 404 pages, favicons, sitemaps for each site
1. Dynamic Open Graph images for each blog post

![CleanShot 2023-07-05 at 08.39.10.png](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F7tiAitb8kdgUGktycr540c%2Fd33f2834f9356bce25e0721c4ebe4f9a%2FCleanShot_2023-07-05_at_08.39.10.png&w=1920&q=75)

![CleanShot 2023-07-05 at 08.39.02.png](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2Fk7XpXIE0rDsHCAYvkKhff%2Fff44c07588068d8fefa334cd6a318c8a%2FCleanShot_2023-07-05_at_08.39.02.png&w=1920&q=75)

## Option 1: Deploying from the Template

### 1. Start the deployment

* Click the deploy button on the[Platforms Starter Kit](https://vercel.com/templates/next.js/platforms-starter-kit)template page
* Choose where you would like to clone the repository and click Create

### 2. Add storage

In the Add Storage section, select the Postgres Database option that is available to you. The Vercel integration will create and provision a Postgres database, connect it to your new project and add the required environment variables

### 3. Add environment variables

In this section, you will create the values of the following required environment variables:

`NEXT_PUBLIC_ROOT_DOMAIN`: This is the root domain of your app such as`mydomain.com`,`okta.com,``hashnode.dev,`etc.

`NEXTAUTH_SECRET,``AUTH_GITHUB_ID`&`AUTH_GITHUB_SECRET`: These are the secrets required for GitHub OAuth and login via NextAuth.js.

* You can use the[GitHub OAuth clients generator](https://github-client-generator.vercel.app/)to create values for`AUTH_SECRET, AUTH_GITHUB_ID & AUTH_GITHUB_SECRET`. When pasting them, you will need to use the value of`AUTH_SECRET`for`NEXTAUTH_SECRET.`

`AUTH_BEARER_TOKEN`: This is your Vercel authentication token.

* You can use an existing one or create a new one from your[Account Tokens page](https://vercel.com/account/tokens)

`PROJECT_ID_VERCEL`: This is your Vercel Project ID that can be found in your Vercel[Project settings page](https://vercel.com/docs/projects/project-configuration/general-settings#project-name)under Project Name

* Since you haven't deployed your project to Vercel yet, use a test value like`my-new-project.`

`TEAM_ID_VERCEL`: This is your Vercel Team ID that can be found in your Vercel Team[Settings](https://vercel.com/docs/dashboard-features#settings)page under**General**.

`OPENAI_API_KEY`: This is used for the AI text generation in the text editor.

* From a new or existing OpenAI account, generate a key from the[API keys section](https://platform.openai.com/account/api-keys).

### 4. Deploy and update

Click the**Deploy**button. Once your project is deployed, you will be taken to the project's deployment page.

#### Update the  PROJECT_ID_VERCEL  environment variable.

* Go to the[project's settings page](https://vercel.com/docs/projects/project-configuration/general-settings#project-name).
* Locate the value of**Project Name**such as`platforms-starter-kit.`
* In the[Environment Variables section](https://vercel.com/docs/projects/environment-variables/managing-environment-variables)of your Project's Settings page, update the value of the`PROJECT_ID_VERCEL`with this value.

#### Update your Project's domain settings

* Add the[root domain](https://vercel.com/docs/projects/domains/add-a-domain#add-your-domain)which will be the same value as`NEXT_PUBLIC_ROOT_DOMAIN`such as mydomain.com. Ignore the recommended step to "add the`www.`version of your domain and redirect your root domain to it".
* Add a[wildcard domain](https://vercel.com/docs/projects/domains/add-a-domain#using-wildcard-domain), such as`*.mydomain.com`to handle the creation of sites with any subdomain under your main domain. Your domain needs to be connected to Vercel with the[nameservers method](https://vercel.com/docs/projects/domains/working-with-nameservers)for this to work.

#### Update the callback URLs

For the GitHub App created by the[GitHub OAuth clients](https://github-client-generator.vercel.app/)[generator](https://github-client-generator.vercel.app/):

* Go to[Developer Settings](https://github.com/settings/apps)on GitHub and click on the GitHub app that you created.
* Under the**Identifying and authorizing users**section, add the following 2 callback URLs:
* `http://app.localhost:3000/api/auth/callback/github`(for local development)
* `https://app.<YOURDOMAIN.COM>/api/auth/callback/github`

#### Test your application

* [Redeploy your production deployment](https://vercel.com/docs/deployments/managing-deployments#redeploy-a-project)and visit app.mydomain.com.
* Log in with your Github account and create a site under**Sites.**
* Test that the sub site with a new subdomain works.

## Option 2: Deploying from the Github repository

## 1. Set up your Next.js project

We’ll be using the[Platforms Starter Kit](https://github.com/vercel/platforms)repository to kickstart our Next.js project.

First, open your terminal and run the following:

```
npx create-next-app --example https://github.com/vercel/platforms platforms
```

This will create a new folder in your current directory called`platforms`. Note that you might run into[dependency tree resolving issues](https://github.com/vercel/platforms/issues/238)during this step, but you can safely ignore it.

Once this step is complete, igate into the folder and launch the app with`pnpm`:

```
cd
 platforms
&&

pnpm
 i
&&

pnpm
 dev
```

The new application has the following structure:

```
app/
  api/
  app/
    (auth)
        login/page.tsx
        layout.tsx
    (dashboard)
         post/[id]
         settings/
         site/[id]
         sites/
         layout.tsx
         loading.tsx
         page.tsx
  home/
     page.tsx
  [domain]
      [slug]/
          not-found.tsx
          opengraph-image.tsx
          page.tsx
      layout.tsx
      page.tsx
```

Aside from the`/api`folder, there are 3 main folders in the`/app`directory:

* `/app`: All routes for the app subdomain ([app.vercel.pub](https://app.vercel.pub/)), where users can customize their individual content pages. As you can see, we're using[route groups](https://nextjs.org/docs/app/building-your-application/routing/route-groups)to customize the layout for the`auth`and`dashboard`pages.
* `/home`: All routes for the landing page ([vercel.pub](https://vercel.pub/)). Note that in the example template, we have a[middleware redirect](https://github.com/vercel/platforms/blob/main/middleware.ts#L41-L52)that redirects this to the[announcement blog post](https://vercel.com/blog/platforms-starter-kit). Feel free to change that to rewrite to the`/home`route instead.
* `/[domain]`: All routes for all custom domains & subdomains (e.g.[demo.vercel.pub](https://demo.vercel.pub/),[steven.vercel.pub](https://steven.vercel.pub/),[platformize.co](https://platformize.co/)).

These folders contain the basic app structure for a multi-tenant app and leverages the latest Next.js App Router features like[Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions),[revalidateTag](https://nextjs.org/docs/app/api-reference/functions/revalidateTag),[dynamic OG images](https://vercel.com/docs/concepts/functions/edge-functions/og-image-generation), etc.

## 2. Set up environment variables

To run this app, we'll need to set up the required environment variables.

To do that, convert the`.env.example`file that’s located at the root of the repo into a`.env`file.

Here are the set up instructions for each of the environment variables:

* `NEXT_PUBLIC_ROOT_DOMAIN`: This is the domain of your app (e.g.`vercel.app, okta.com,``hashnode.dev`etc.)
* `POSTGRES_URL`:[Follow the getting started steps](https://vercel.com/docs/storage/vercel-postgres#getting-started)to provision a Marketplace Postgres instance. If you have already deployed the template, you can pull the env vars with the Vercel CLI by running`vc env pull`([Review the vercel env CLI docs](https://vercel.com/docs/cli/env#exporting-development-environment-variables)).
* `BLOB_READ_WRITE_TOKEN`:[Follow the Vercel Blob quickstart](https://vercel.com/docs/storage/blob/quickstart)to provision a Vercel Blob instance. If you have already deployed the template, you can pull the env vars with the Vercel CLI by running`vc env pull.`
* `NEXTAUTH_SECRET`,`AUTH_GITHUB_ID`&`AUTH_GITHUB_SECRET`: These are the secrets required for GitHub OAuth and login via NextAuth.js.  You can use the[GitHub OAuth clients generator](https://github-client-generator.vercel.app/)to create values for`AUTH_SECRET, AUTH_GITHUB_ID & AUTH_GITHUB_SECRET`. When pasting them, you will need to use the value of`AUTH_SECRET`for`NEXTAUTH_SECRET.`
* `AUTH_BEARER_TOKEN`: This is your Vercel authentication token. You can use an existing one or create a new one from your[Account Tokens page](https://vercel.com/account/tokens).
* `PROJECT_ID_VERCEL`: This is your Vercel Project ID that can be found in your Vercel[Project settings page](https://vercel.com/docs/projects/project-configuration/general-settings#project-name)under Project Name. Since you haven't deployed your project to Vercel yet, use a test value like`my-new-project`.
* `TEAM_ID_VERCEL`: This is your Vercel Team ID that can be found in your Vercel Team[Settings](https://vercel.com/docs/dashboard-features#settings)page under**General**.
* `OPENAI_API_KEY`: This is required for AI text generation in the text editor. From a new or existing OpenAI account, generate a key from the[API keys section](https://platform.openai.com/account/api-keys).

## 3. Publish your Prisma Schema

The template comes pre-populated with the necessary Prisma schema for this app. All you need to do to publish this schema to your database is run the following command:

```
npx prisma db push
```

Note: If you have already cloned and deployed the template, you can skip this step, since the[build](https://github.com/vercel/platforms/blob/main/package.json#L5)automatically runs`prisma db push`for you.

## 4. Update your NextAuth.js callback URLs

In step 2, we set up a GitHub app using the[GitHub Client Generator](https://github-client-generator.vercel.app/).

However, we still need to customize the callback URLs for the GitHub App in order for the OAuth process to work properly

First, go to[Developer Settings](https://github.com/settings/apps)on GitHub and click on the GitHub app that you created earlier. Then, under the "Identifying and authorizing users" section, add the following 2 callback URLs:

1. `http://app.localhost:3000/api/auth/callback/github`
1. `https://app.<YOURDOMAIN.COM>/api/auth/callback/github`

Save your changes, and you're all set! You can now go back to the app login page and log in with GitHub.

![CleanShot 2023-06-29 at 21.31.33.png](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F7JIPfJ9ZT2bvvmfbJBD9eE%2F6b90a5424808cc3011478463801b5c74%2FCleanShot_2023-06-29_at_21.31.33.png&w=1920&q=75)

## 5. Deploy to Vercel

Finally, we’ll be deploying the repo to Vercel.

1. First, create a new Github repository and push your local changes.

2.[Deploy it to Vercel.](https://vercel.com/docs/concepts/deployments/git#deploying-a-git-repository)Ensure you add all environment variables that you configured earlier to Vercel during the import process.

3. In your Vercel project, add your[root domain & wildcard domain](https://vercel.com/docs/projects/domains/add-a-domain).

* Add the[root domain](https://vercel.com/docs/projects/domains/add-a-domain#add-your-domain)which will be the same value as`NEXT_PUBLIC_ROOT_DOMAIN`such as mydomain.com. Ignore the recommended step to "add the`www.`version of your domain and redirect your root domain to it".
* Add a[wildcard domain](https://vercel.com/docs/projects/domains/add-a-domain#using-wildcard-domain), such as`*.mydomain.com`to handle the creation of sites with any subdomain under your main domain. Your domain needs to be connected to Vercel with the[nameservers method](https://vercel.com/docs/projects/domains/working-with-nameservers)for this to work.

![8.png](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F2HKOQKhBjWBHICbo4lNu8z%2F69b0d761c0913c55e17a6f4c33b1df3a%2F8.png&w=828&q=75)

That's it – you can now go to`app.<YOURDOMAIN.COM>`, log in, and start creating some sites!

## Caveats

Throughout this process, there are several caveats that you should pay attention to:

### 1. Handling duplicate content between subdomain and custom domain

You might've noticed that we are generating two different sites for subdomains and custom domains. There are a few ways you can improve on this:

* Redirect subdomain to custom domain if exists: We actually have a[section in the code](https://github.com/vercel/platforms/blob/eeabcf1c8e29f5db86c15d71e98b8eded43bd341/app/%5Bdomain%5D/layout.tsx#L74-L81)that lets you do that.
* Setting a canonical URL that points to the custom domain if it exists ([refer code](https://github.com/vercel/platforms/blob/eeabcf1c8e29f5db86c15d71e98b8eded43bd341/app/%5Bdomain%5D/layout.tsx#L50-L56)).

### 2. Allow adding and redirecting  www.  subdomains to apex domain

As a platform owner, you might want to allow your users to add`www`. subdomains along with their apex domain (and have the former redirect to the latter).

To achieve that behavior, you will need to[make an additional API call](https://github.com/vercel/platforms/blob/1ed55b13bcae97b037c69ec40b4c32df21c2412c/lib/actions.ts#L90-L91)to the Vercel Domains API to add the`www.`version for a domain and[set a redirect attribute](https://github.com/vercel/platforms/blob/2435c669f3d245496041704a0d963b5ab37b3f7b/lib/domains.ts#L22-L25)to make it redirect to the apex domain.

### 3. Multi-tenant Preview URLs (Enterprise Only)

When you push changes, you might want to test each tenant’s site with a unique Vercel preview URL. This is especially useful for showing changes to a tenant before they go live.

You can use[Preview Deployment Suffixes](https://vercel.com/docs/deployments/generated-urls#preview-deployment-suffix)allow dynamic subdomains like:

* `tenant1---branch-name.yourdomain.dev`
* `tenant2---branch-name.yourdomain.dev`

This feature is only available for Enterprise customers on Vercel – if you're interested in testing it out, please reach out to your Customer Success Manager (CSM) and we will enable it for your preview deployment suffix.

**Note:**there is a[63 character limit](https://vercel.com/guides/why-is-my-vercel-deployment-url-being-shortened#rfc-1035)so long branch URLs (including the`<tenant-slug>---`section) may fail to resolve. To resolve this, you should use shorter branch names.

### 4. Sign-in With Google limitations in localhost

If you're using[Google as an OAuth provider](https://next-auth.js.org/providers/google), you might run into an issue where Google does not allow you to add localhost subdomains as an Authorized redirect URI:

![272703853-bacefbd2-67e6-439a-a27d-2606e0a6b690.jpg](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F7tpz8FETgYtpnwADqLpFl8%2F0967674941a158106db60c172e3a849c%2F272703853-bacefbd2-67e6-439a-a27d-2606e0a6b690.jpg&w=1920&q=75)

This is a known limitation – to fix this, you can just use a different localhost port (e.g.`localhost:8888`) in lieu of`app.localhost:3000`. You will need to update your`NEXTAUTH_URL`environment variable to reflext this change.

## Bonus: Pageviews Analytics

You might notice that the analytics section of each site is filled with dummy data (with beautiful charts powered by[Tremor](https://tremor.so/)):

![CleanShot 2023-06-29 at 22.04.05.png](/_next/image?url=https%3A%2F%2Fimages.ctfassets.net%2Fe5382hct74si%2F531n200zmU8qMCIhM1BaqQ%2F3039400f850c54fd5cedb065ca68b47e%2FCleanShot_2023-06-29_at_22.04.05.png&w=1920&q=75)

We highly recommend using a service like[Tinybird](https://www.tinybird.co/)to ingest, store, and visualize pageview data for each of your sites. In fact, they have an[open-source starter kit](https://www.tinybird.co/starter-kits/web-analytics)that shows how you can set this up in less than 5 minutes – we highly recommend trying it out!

## Conclusion

In this guide, you learned how to build a full-stack multi-tenant application by using the[Platforms Starter Kit](https://demo.vercel.pub/platforms-starter-kit). From blogging platforms to low-code tools, this starter kit can be a starter kit for a number of different types of applications, we’re excited to see what you build!

If you run into any issues or have any questions about this guide, feel free to raise them on[GitHub](https://github.com/vercel/platforms/issues)or drop them in the[Next.js Discord](https://nextjs.org/discord).

### Couldn't find the guide you need?

[View Help](/help#community)